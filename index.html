<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Facing Worlds Mini Game</title>

    <!-- A-Frame + Extras -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>

    <!-- Spawns the rig onto the navmesh center by raycast -->
    <script src="build-navmesh.js"></script>
    <script src="spawn-on-navmesh.js"></script>
    <script src="stick-to-navmesh.js"></script>

    <link rel="icon" href="data:," />
  </head>
  <body>
    <a-scene
      responsive-immersive
      xrextras-gesture-detector
      landing-page
      xrextras-loading
      xrextras-runtime-error
      renderer="colorManagement:true"
      xrweb="allowedDevices: any; defaultEnvironmentFloorScale: 0.25">
      <a-assets>
        <a-asset-item id="robot_model" src="Character.glb"></a-asset-item>

        <!-- Ideally this is a simplified walkable mesh, but can be the same GLB for now -->
        <a-asset-item id="navmesh-glb" src="FacingWorlds.glb"></a-asset-item>
        <a-asset-item id="model-glb" src="FacingWorlds.glb"></a-asset-item>
      </a-assets>

      <!-- Lighting -->
      <a-entity
        light="type: directional;
               shadowBias: -0.0001;
               intensity: 0.65;
               castShadow: true;
               shadowMapHeight:2048;
               shadowMapWidth:2048;
               shadowCameraTop: 40;
               shadowCameraBottom: -40;
               shadowCameraRight: 40;
               shadowCameraLeft: 40;
               target: #model"
        xrextras-attach="target: model; offset: 8 15 4"
        position="1 4.3 2.5"
        shadow>
      </a-entity>
      <a-light type="ambient" intensity="0.4"></a-light>

      <!-- Mark this as the NAVMESH -->
      <!-- Make it visible first to verify alignment -->
      <a-entity id="navmesh" class="navmesh" gltf-model="#navmesh-glb" build-navmesh="slopeMax: 35; debug: true" visible="true"></a-entity>

      <!-- Environment -->
      <a-entity id="model" gltf-model="#model-glb" shadow></a-entity>

      <!-- THIRD-PERSON RIG constrained to the navmesh -->
      <a-entity
        id="rig"
        position="0 1.2 0"
        movement-controls="constrainToNavMesh: true; speed: 0.1"
        navmesh-constraint="navmesh: #navmesh; fall: 6; height: 0.11"
        stick-to-navmesh="navmesh: #navmesh; height: 0.11; fallMax: 8; stepMax: 0.35">
        <a-entity camera look-controls position="0 2 4"></a-entity>
        <a-entity id="character" gltf-model="#robot_model" scale="0.05 0.05 0.05"></a-entity>
      </a-entity>

      <!-- Optional shadow receiver -->
      <a-plane id="ground" rotation="-90 0 0" position="0 -.1 0" width="1000" height="1000" material="shader: shadow" shadow></a-plane>
    </a-scene>
  </body>
</html>
